<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ–ª–æ –≤ –®–ª—è–ø–µ üéì | –®–∫–æ–ª–∞ –ò–ª–ª—é–∑–∏–π</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Permanent+Marker&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–ò–ó–ê–ô–ù–ê "–î–ï–õ–û –í –®–õ–Ø–ü–ï" - –ú–Ø–ì–ö–ê–Ø –ü–ê–õ–ò–¢–†–ê --- */
        :root {
            /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞: –ù–µ–∂–Ω—ã–π –ñ–µ–ª—Ç—ã–π, –ú—è–≥–∫–∏–π –ß–µ—Ä–Ω—ã–π (–¢–µ–º–Ω–æ-–°–µ—Ä—ã–π), –ë–µ–ª—ã–π */
            --primary-color: #333333; /* –ú—è–≥–∫–∏–π —Ç–µ–º–Ω–æ-—Å–µ—Ä—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –∏ –∫–æ–Ω—Ç—É—Ä–æ–≤ */
            --secondary-color: #FFFFFF; /* –ë–µ–ª—ã–π –¥–ª—è —Ñ–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
            --accent-color: #E67E22; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π/—Ç—ã–∫–≤–µ–Ω–Ω—ã–π –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ */
            --bg-light: #FFF0B5; /* –ù–µ–∂–Ω—ã–π, –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –∂–µ–ª—Ç—ã–π (–∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω) */
            --card-shadow: 0 5px 0px 5px rgba(51, 51, 51, 0.7); /* –¢–µ–Ω—å –æ—Ç –º—è–≥–∫–æ–≥–æ —á–µ—Ä–Ω–æ–≥–æ */
            --text-stroke-color: #FFFFFF; /* –û–±–≤–æ–¥–∫–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–µ—Ç—Ä–æ-—ç—Ñ—Ñ–µ–∫—Ç–∞ */
            --border-thick: 3px solid var(--primary-color); 
            --gold-color: #FFD700;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∏ –æ–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        @keyframes slideIn {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes fanfare {
            0% { transform: scale(0.8) rotateX(90deg); opacity: 0; }
            100% { transform: scale(1) rotateX(0deg); opacity: 1; }
        }
        
        @keyframes pulse {
             0% { transform: scale(1); }
             50% { transform: scale(1.05); opacity: 0.8; }
             100% { transform: scale(1); }
         }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-light);
            color: var(--primary-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            border: 8px solid var(--primary-color);
        }

        /* --- –ê–£–î–ò–û/–≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø --- */
        #audio-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background-color: var(--secondary-color);
            border: var(--border-thick);
            border-radius: 50%;
            width: 45px; 
            height: 45px; 
            cursor: pointer;
            font-size: 1.4em; 
            line-height: 43px; 
            text-align: center;
            box-shadow: 2px 2px 0 var(--primary-color);
            transition: transform 0.1s;
        }
        .control-button:active {
            transform: translate(2px, 2px); 
            box-shadow: none;
        }

        /* –®–∞–ø–∫–∞ */
        header {
            background-color: var(--primary-color);
            color: var(--bg-light);
            padding: 15px 0; 
            text-align: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3); 
            font-family: 'Permanent Marker', cursive;
            border-bottom: 3px solid var(--accent-color); 
        }
        header h1 {
            font-size: 2.8em; 
            text-shadow: 3px 3px 0 var(--accent-color), 
                         6px 6px 0 rgba(0, 0, 0, 0.15); 
            line-height: 0.9;
            padding: 5px; 
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ */
        main {
            padding: 25px 0; /* –£–º–µ–Ω—å—à–∞–µ–º –±–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã main –¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏ */
            flex-grow: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        /* --- –ë–õ–û–ö –í–´–ë–û–†–ê –ö–£–†–°–ê: –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–ê–Ø –ö–ê–†–£–°–ï–õ–¨ --- */
        #course-selection {
            text-align: center;
            padding: 0 10px; /* –ù–µ–±–æ–ª—å—à–∏–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        }
        #course-selection h2 {
            font-family: 'Bebas Neue', sans-serif;
            color: var(--primary-color);
            font-size: 2.8em; 
            margin-bottom: 30px;
            text-transform: uppercase;
            -webkit-text-stroke: 1.2px var(--text-stroke-color); 
            text-stroke: 1.2px var(--text-stroke-color);
            border-bottom: 2px dashed var(--primary-color); 
            padding-bottom: 10px;
            max-width: 760px;
            margin: 0 auto 30px auto;
        }

        .carousel-wrapper {
            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ */
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding: 10px 0;
            margin-bottom: 20px;
            /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .carousel-wrapper::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .course-carousel {
            display: flex;
            gap: 20px;
            padding: 0 10px; /* –û—Ç—Å—Ç—É–ø –ø–æ –∫—Ä–∞—è–º –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
            width: max-content;
        }

        .course-card {
            background-color: var(--secondary-color);
            border-radius: 12px;
            padding: 15px;
            min-width: 200px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –ö–∞—Ä—É—Å–µ–ª–∏ */
            max-width: 220px;
            height: 300px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è */
            box-shadow: 5px 5px 0 var(--primary-color);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid var(--primary-color);
            scroll-snap-align: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
            
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã */
            
            /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –ø–æ –æ—á–µ—Ä–µ–¥–∏ –≤—ã–ª–µ—Ç–∞—é—Ç */
            animation: slideIn 0.5s ease-out forwards;
        }
        /* –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "–≤–µ–µ—Ä–∞" */
        .course-card:nth-child(2) { animation-delay: 0.1s; }
        .course-card:nth-child(3) { animation-delay: 0.2s; }
        .course-card:nth-child(4) { animation-delay: 0.3s; }
        /* –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ... */


        .course-card:hover {
            transform: translateY(-5px) scale(1.05); /* –≠—Ñ—Ñ–µ–∫—Ç "–ø—Ä—ã–∂–∫–∞" */
            box-shadow: 8px 8px 0 var(--accent-color);
        }
        
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –∏ –º–∞–ª—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ */
        .course-card[data-type="big"] {
             border-color: var(--gold-color);
             box-shadow: 5px 5px 0 var(--gold-color);
        }

        .course-card h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2em; 
            color: var(--primary-color);
            text-transform: uppercase;
            margin-bottom: 5px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
        }
        
        .course-card p {
            color: #555;
            font-style: italic;
            font-size: 0.9em;
            margin-top: 10px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
        .card-image {
            width: 100%;
            height: 120px; /* –£–≤–µ–ª–∏—á–∏–ª–∏ –≤—ã—Å–æ—Ç—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--primary-color);
            margin-bottom: 10px;
        }

        /* --- –ë–õ–û–ö –ó–ê–ì–õ–£–®–ö–ò –î–õ–Ø –£–†–û–ö–û–í (–¢–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω –æ—Ç –º–∞–≥–∏–∏) --- */
        #lesson-list-view, #video-player-view {
            text-align: center;
            padding: 20px;
            background-color: var(--secondary-color);
            border: var(--border-thick);
            border-radius: 12px;
            box-shadow: 5px 5px 0 var(--primary-color);
            max-width: 500px;
            margin: 20px auto;
        }
        
        #lesson-list-view h2 {
            font-family: 'Permanent Marker', cursive;
            color: var(--accent-color);
            font-size: 2.5em;
            margin-bottom: 20px;
            border-bottom: none;
            text-transform: none;
        }
        
        .placeholder-content {
            padding: 20px 0;
            color: var(--primary-color);
        }
        
        .placeholder-icon {
            font-size: 4em;
            color: var(--gold-color);
            margin-bottom: 10px;
            display: block;
            animation: pulse 2s infinite;
        }

        /* –ö–Ω–æ–ø–∫–∏ (–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è) */
        .back-button, #submit-reg-btn, .form-button {
            background-color: var(--primary-color);
            color: var(--bg-light);
            border: 3px solid var(--primary-color);
            padding: 8px 18px; 
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 18px;
            font-weight: 700;
            transition: all 0.1s;
            width: 100%; 
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4em; 
            box-shadow: 3px 3px 0 var(--accent-color); 
            text-transform: uppercase;
        }
        .back-button:hover, #submit-reg-btn:hover, .form-button:hover {
            background-color: #555;
            box-shadow: 3px 3px 0 var(--bg-light);
        }
        .back-button:active, #submit-reg-btn:active, .form-button:active {
            transform: translate(3px, 3px);
            box-shadow: none;
        }
        
        /* –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞ */
        .hidden { display: none !important; }
        /* ... (–û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ —Ñ–æ—Ä–º –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞) ... */
    </style>
</head>
<body>

    <div id="audio-controls">
        <audio id="bg-music" src="background_music.mp3" loop preload="auto"></audio>
        <button id="music-toggle" class="control-button" title="–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞">‚ñ∂Ô∏è</button>
        <audio id="click-sound" src="click_sound.mp3" preload="auto"></audio>
    </div>

    <header>
        <h1>–î–µ–ª–æ –≤ –®–ª—è–ø–µ üéì</h1>
    </header>

    <main>
        <section id="course-selection">
            <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –æ–±—É—á–∞—é—â–∏–π –Ω–∞–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫</h2>
            
            <div class="carousel-wrapper">
                <div class="course-carousel">
                    <div class="course-card" data-id="set_75" data-type="big">
                        <img src="images/set1.png" alt="75 —Ñ–æ–∫—É—Å–æ–≤" class="card-image">
                        <h3>75 –ö–õ–Æ–ß–ï–í–´–• –¢–ï–•–ù–ò–ö</h3>
                        <p>–ü–æ–ª–Ω–æ–µ –æ—Å–≤–æ–µ–Ω–∏–µ –∏–ª–ª—é–∑–∏–æ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞. –î–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞!</p>
                    </div>
                    <div class="course-card" data-id="set_50" data-type="big">
                        <img src="images/set_new_50.png" alt="50 —Ñ–æ–∫—É—Å–æ–≤" class="card-image">
                        <h3>50 –°–¢–ê–†–¢–û–í–´–• –ü–†–ò–ï–ú–û–í</h3>
                        <p>–ù–∞–¥–µ–∂–Ω–∞—è –±–∞–∑–∞ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ –∏–ª–ª—é–∑–∏–æ–Ω–∏—Å—Ç–∞.</p>
                    </div>
                    <div class="course-card" data-id="set_25" data-type="big">
                        <img src="images/set_new_25.png" alt="25 —Ñ–æ–∫—É—Å–æ–≤" class="card-image">
                        <h3>25 –ë–´–°–¢–†–´–• –°–ï–ö–†–ï–¢–û–í</h3>
                        <p>–ü—Ä–∏–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è!</p>
                    </div>

                    <div class="course-card" data-id="set_blue" data-type="small">
                        <img src="images/set4.jpg" alt="–°–∏–Ω–∏–π –Ω–∞–±–æ—Ä —Ñ–æ–∫—É—Å–æ–≤" class="card-image">
                        <h3>10. –ö–ê–†–ú–ê–ù–ù–´–ï –¢–†–Æ–ö–ò</h3>
                        <p>–° –∫–∞—Ä—Ç–∞–º–∏, –∫—É–ø—é—Ä–∞–º–∏ –∏ –º–æ–Ω–µ—Ç–∫–∞–º–∏.</p>
                    </div>
                    <div class="course-card" data-id="set_red" data-type="small">
                        <img src="images/set5.jpg" alt="–ö—Ä–∞—Å–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ–æ–∫—É—Å–æ–≤" class="card-image">
                        <h3>10. –ò–°–ö–£–°–°–¢–í–û –õ–û–í–ö–û–°–¢–ò</h3>
                        <p>–° –∫–æ–ª—å—Ü–∞–º–∏, —Ü–µ–ø–æ—á–∫–∞–º–∏ –∏ —à–∞—Ä–∏–∫–∞–º–∏.</p>
                    </div>
                    <div class="course-card" data-id="set_yellow" data-type="small">
                        <img src="images/set2.jpg" alt="–ñ–µ–ª—Ç—ã–π –Ω–∞–±–æ—Ä —Ñ–æ–∫—É—Å–æ–≤" class="card-image">
                        <h3>10. –ü–†–ï–î–ú–ï–¢–´ –ò –†–ï–ó–ò–ù–ö–ò</h3>
                        <p>–°–∞–º—ã–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–µ–º—ã —Å –±—ã—Ç–æ–≤—ã–º–∏ –≤–µ—â–∞–º–∏.</p>
                    </div>
                    <div class="course-card" data-id="set_green" data-type="small">
                        <img src="images/set3.jpg" alt="–ó–µ–ª–µ–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ–æ–∫—É—Å–æ–≤" class="card-image">
                        <h3>10. –°–¶–ï–ù–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ï–ú–´</h3>
                        <p>–†–∞–±–æ—Ç–∞ —Å —Ç—Ä–æ—Å—Ç—å—é, –ø–ª–∞—Ç–∫–∞–º–∏ –∏ –∂–µ—Å—Ç–∞–º–∏.</p>
                    </div>
                </div>
            </div>
            <p style="text-align: center; color: var(--primary-color); font-weight: 700; margin-top: 15px;">
                 &larr; **–°–º–∞—Ö–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –Ω–∞–±–æ—Ä—ã** &rarr;
            </p>
        </section>

        <section id="lesson-list-view" class="hidden">
            <button class="back-button" onclick="showCourseSelection()">
                &larr; –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –Ω–∞–±–æ—Ä–æ–≤
            </button>
            <h2 id="lesson-list-title">–ù–∞–±–æ—Ä: [–ù–∞–∑–≤–∞–Ω–∏–µ –ù–∞–±–æ—Ä–∞]</h2>

            <div class="placeholder-content">
                <span class="placeholder-icon">‚è≥</span>
                <p style="font-size: 1.1em; font-weight: 700; margin-bottom: 10px;">
                    –í–∏–¥–µ–æ-—É—Ä–æ–∫–∏ –¥–ª—è –Ω–∞–±–æ—Ä–∞ **<span id="placeholder-course-name"></span>** –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.
                </p>
                <p>
                    –ú—ã –≥–æ—Ç–æ–≤–∏–º –¥–ª—è –≤–∞—Å –ª—É—á—à–∏–µ –æ–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã. 
                    –°–∫–æ—Ä–æ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å! 
                    <br>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ.
                </p>
            </div>
            
            <ul id="lesson-list" class="hidden"></ul>
        </section>

        <section id="video-player-view" class="hidden">
            <button class="back-button" onclick="goBackToLessonList()">
                &larr; –ù–∞–∑–∞–¥ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–∞–±–æ—Ä–µ
            </button>
            <div class="placeholder-content">
                <span class="placeholder-icon">üö´</span>
                <p style="font-size: 1.1em; font-weight: 700;">
                    –í–∏–¥–µ–æ-–∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
                </p>
                <p>
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞–±–æ—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ.
                </p>
            </div>
        </section>
    </main>

    <div id="registration-overlay" class="registration-overlay hidden">
        <div class="registration-modal">
            <h2 id="modal-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            
            <div id="modal-content-container" class="modal-content-container">
                </div>
        </div>
    </div>


    <script>
        // --- 0. –ö–û–ù–°–¢–ê–ù–¢–´ –ò URL –°–ï–†–í–ï–†–ê ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby2R4j1aBQ2zmybXyqjVhgFntoduCYYX6AuZ8kMmRUWdF8ZQCNTTpPij0kmxaSxAZmjvg/exec'; 

        const IMAGE_BASE_URL = 'images/';
        const USER_STORAGE_KEY = 'magic_course_user_registered';
        const TG_ID_STORAGE_KEY = 'magic_course_tg_id';
        
        // --- –ó–ê–ì–õ–£–®–ö–ê –î–õ–Ø –£–†–û–ö–û–í ---
        const EMPTY_LESSONS = []; 

        // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï –ö–£–†–°–û–í (7 –Ω–∞–±–æ—Ä–æ–≤) ---
        const courses = {
            set_75: { title: '75 –ö–ª—é—á–µ–≤—ã—Ö –¢–µ—Ö–Ω–∏–∫', lessons: EMPTY_LESSONS, description: '–ü–æ–ª–Ω–æ–µ –æ—Å–≤–æ–µ–Ω–∏–µ –∏–ª–ª—é–∑–∏–æ–Ω–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞. –î–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞!' },
            set_50: { title: '50 –°—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ü—Ä–∏–µ–º–æ–≤', lessons: EMPTY_LESSONS, description: '–ù–∞–¥–µ–∂–Ω–∞—è –±–∞–∑–∞ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ –∏–ª–ª—é–∑–∏–æ–Ω–∏—Å—Ç–∞.' },
            set_25: { title: '25 –ë—ã—Å—Ç—Ä—ã—Ö –°–µ–∫—Ä–µ—Ç–æ–≤', lessons: EMPTY_LESSONS, description: '–ü—Ä–∏–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è!' },

            set_blue: { title: '10. –ö–∞—Ä–º–∞–Ω–Ω—ã–µ –¢—Ä—é–∫–∏', lessons: EMPTY_LESSONS, description: '–° –∫–∞—Ä—Ç–∞–º–∏, –∫—É–ø—é—Ä–∞–º–∏ –∏ –º–æ–Ω–µ—Ç–∫–∞–º–∏.' },
            set_red: { title: '10. –ò—Å–∫—É—Å—Å—Ç–≤–æ –õ–æ–≤–∫–æ—Å—Ç–∏', lessons: EMPTY_LESSONS, description: '–° –∫–æ–ª—å—Ü–∞–º–∏, —Ü–µ–ø–æ—á–∫–∞–º–∏ –∏ —à–∞—Ä–∏–∫–∞–º–∏.' }, 
            set_yellow: { title: '10. –ü—Ä–µ–¥–º–µ—Ç—ã –∏ –†–µ–∑–∏–Ω–∫–∏', lessons: EMPTY_LESSONS, description: '–°–∞–º—ã–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–µ–º—ã —Å –±—ã—Ç–æ–≤—ã–º–∏ –≤–µ—â–∞–º–∏.' },
            set_green: { title: '10. –°—Ü–µ–Ω–∏—á–µ—Å–∫–∏–µ –ü—Ä–∏–µ–º—ã', lessons: EMPTY_LESSONS, description: '–†–∞–±–æ—Ç–∞ —Å —Ç—Ä–æ—Å—Ç—å—é, –ø–ª–∞—Ç–∫–∞–º–∏ –∏ –∂–µ—Å—Ç–∞–º–∏.' },
        };

        // --- 2. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø ---

        let courseSelectionPage;
        let lessonListView;
        let videoPlayerView;
        let lessonList;
        let currentCourseId = null;

        // –ê—É–¥–∏–æ
        let bgMusic;
        let clickSound;
        let isMusicPlaying = false;
        let isSoundEnabled = true;
        let kinescopePlayer;

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        let registrationOverlay;
        let policyInitialView, policyFullView, registrationFormView, successView;
        let registrationForm;
        let loadingSpinner;


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
        function initializeDOMElements() {
            courseSelectionPage = document.getElementById('course-selection');
            lessonListView = document.getElementById('lesson-list-view');
            videoPlayerView = document.getElementById('video-player-view');
            lessonList = document.getElementById('lesson-list');
            loadingSpinner = document.getElementById('loading-spinner');
            kinescopePlayer = document.getElementById('kinescope-player');

            // –ê—É–¥–∏–æ
            bgMusic = document.getElementById('bg-music');
            clickSound = document.getElementById('click-sound');
            document.getElementById('music-toggle').addEventListener('click', toggleMusic);
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            registrationOverlay = document.getElementById('registration-overlay');
            policyInitialView = document.getElementById('policy-initial-view');
            policyFullView = document.getElementById('policy-full-view');
            registrationFormView = document.getElementById('registration-form-view');
            successView = document.getElementById('success-view');
            registrationForm = document.getElementById('registration-form');

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('read-policy-btn').addEventListener('click', showPolicyFullView);
            document.getElementById('agree-and-continue-btn').addEventListener('click', showRegistrationForm);
            document.getElementById('agree-final-btn').addEventListener('click', showRegistrationForm);
            
            registrationForm.addEventListener('submit', handleRegistrationSubmit);
            
            // –î–û–ë–ê–í–õ–ï–ù–û: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π Telegram WebApp
            setupTelegramWebAppEvents();
        }

        // --- 3. –ê–£–î–ò–û –§–£–ù–ö–¶–ò–ò (–û–°–¢–ê–í–õ–ï–ù–´) ---

        function playClickSound() {
            if (isSoundEnabled && clickSound) {
                clickSound.currentTime = 0;
                clickSound.play().catch(e => console.log("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ –∫–ª–∏–∫–∞:", e));
            }
        }

        function toggleMusic() {
            const btn = document.getElementById('music-toggle');
            if (isMusicPlaying) {
                bgMusic.pause();
                isMusicPlaying = false;
                btn.textContent = '‚ñ∂Ô∏è';
                btn.title = '–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞';
            } else {
                bgMusic.play().then(() => {
                    isMusicPlaying = true;
                    btn.textContent = '‚è∏Ô∏è';
                    btn.title = '–ü–∞—É–∑–∞';
                }).catch(e => {
                    isMusicPlaying = false;
                    btn.textContent = '‚ñ∂Ô∏è';
                });
            }
        }

        function pauseMusicForVideo() {
            if (isMusicPlaying) {
                bgMusic.pause();
            }
        }

        function resumeMusicAfterVideo() {
            if (isMusicPlaying) {
                bgMusic.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –º—É–∑—ã–∫—É:", e));
            }
        }
        
        function setupTelegramWebAppEvents() {
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        if (isMusicPlaying) {
                            bgMusic.pause();
                        }
                    } else {
                        if (isMusicPlaying) {
                            resumeMusicAfterVideo();
                        }
                    }
                });
            }
        }

        // --- 4. –ù–ê–í–ò–ì–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶: –ê–î–ê–ü–¢–ò–†–û–í–ê–ù–û –ü–û–î –ó–ê–ì–õ–£–®–ö–ò ---

        function startApp() {
            document.body.addEventListener('click', () => {
                if (!isMusicPlaying && bgMusic.paused) {
                    toggleMusic();
                }
            }, { once: true });

            handleInitialCheck(); 
            showCourseSelection();
        }

        function showCourseSelection() {
            courseSelectionPage.classList.remove('hidden');
            lessonListView.classList.add('hidden');
            videoPlayerView.classList.add('hidden'); 
        }

        function showLessonList(courseId) {
            currentCourseId = courseId;
            courseSelectionPage.classList.add('hidden');
            lessonListView.classList.remove('hidden');
            videoPlayerView.classList.add('hidden'); 
            
            const course = courses[courseId];
            document.getElementById('lesson-list-title').textContent = `–ù–∞–±–æ—Ä: ${course.title}`;
            document.getElementById('placeholder-course-name').textContent = course.title;
            
            lessonListView.scrollIntoView({ behavior: 'smooth' });
        }

        function playLesson(lesson, clickedElement) {
             // –ü–æ—Å–∫–æ–ª—å–∫—É —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –≤—ã–±–æ—Ä—É –Ω–∞–±–æ—Ä–∞
             goBackToLessonList(); 
        }

        function goBackToLessonList() {
            playClickSound();
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –≤—ã–±–æ—Ä—É –Ω–∞–±–æ—Ä–∞
            showCourseSelection();
        }

        // --- 5. –õ–û–ì–ò–ö–ê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ô –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò (–û–°–¢–ê–í–õ–ï–ù–´) ---

        function getTelegramIdFromContext() {
            if (window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                return Telegram.WebApp.initDataUnsafe.user.id.toString();
            }
            const urlParams = new URLSearchParams(window.location.search);
            const tgIdFromUrl = urlParams.get('tg_id');
            return tgIdFromUrl || localStorage.getItem(TG_ID_STORAGE_KEY) || 'null';
        }

        function handleInitialCheck() {
            const registered = localStorage.getItem(USER_STORAGE_KEY);
            const tgId = getTelegramIdFromContext();
            
            if (registered === 'true') {
                 hideRegistrationModal();
            } else {
                if (tgId && tgId !== 'null' && tgId !== 'undefined') {
                    document.getElementById('reg-tg-id').value = tgId;
                    showRegistrationModal(true);
                } else {
                    showRegistrationModal(false);
                }
            }
        }

        function showRegistrationModal(skipPolicy = false) {
            registrationOverlay.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            
            [policyFullView, registrationFormView, successView].forEach(view => view.classList.add('hidden'));

            if (skipPolicy) {
                showRegistrationForm();
            } else {
                policyInitialView.classList.remove('hidden');
                document.getElementById('modal-title').textContent = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!";
            }
        }

        function hideRegistrationModal() {
            registrationOverlay.classList.add('hidden');
        }
        
        function showPolicyFullView() {
            playClickSound();
            policyInitialView.classList.add('hidden');
            policyFullView.classList.remove('hidden');
            document.getElementById('modal-title').textContent = "–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏";
        }

        function showRegistrationForm() {
            playClickSound();
            policyInitialView.classList.add('hidden');
            policyFullView.classList.add('hidden');
            registrationFormView.classList.remove('hidden');
            document.getElementById('modal-title').textContent = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
            
            const tgId = getTelegramIdFromContext();
            if (tgId && tgId !== 'null' && tgId !== 'undefined') {
                 document.getElementById('reg-tg-id').value = tgId;
            }
        }

        function showSuccessView() {
            [policyInitialView, policyFullView, registrationFormView, loadingSpinner].forEach(view => view.classList.add('hidden'));
            
            successView.classList.remove('hidden');
            document.getElementById('modal-title').textContent = "–ì–æ—Ç–æ–≤–æ!";
        }

        function showLoadingSpinner() {
            [policyInitialView, policyFullView, registrationFormView, successView].forEach(view => view.classList.add('hidden'));
            loadingSpinner.classList.remove('hidden');
            document.getElementById('modal-title').textContent = "–ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö...";
        }

        async function handleRegistrationSubmit(event) {
            event.preventDefault();
            playClickSound();
            showLoadingSpinner();

            const formData = new FormData(registrationForm);
            const data = Object.fromEntries(formData.entries());
            
            if (data.tg_id && data.tg_id !== 'null' && data.tg_id !== 'undefined') {
                data.source = "–¢–µ–ª–µ–≥—Ä–∞–º";
            } else {
                data.source = "–°–∞–π—Ç";
            }
            
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                localStorage.setItem(USER_STORAGE_KEY, 'true'); 
                if (data.source === "–¢–µ–ª–µ–≥—Ä–∞–º") {
                     localStorage.setItem(TG_ID_STORAGE_KEY, data.tg_id);
                }
                
                showSuccessView();

            } catch (error) {
                document.getElementById('modal-title').textContent = "–û—à–∏–±–∫–∞!";
                loadingSpinner.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.";
                setTimeout(() => {
                    showRegistrationModal(data.source === "–¢–µ–ª–µ–≥—Ä–∞–º");
                }, 3000); 
            }
        }

        // --- 6. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMElements(); 
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.course-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    playClickSound();
                    const courseId = event.currentTarget.getAttribute('data-id');
                    showLessonList(courseId);
                });
            });
            
            startApp();
        });
    </script>
</body>
</html>
